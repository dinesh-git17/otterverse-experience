name: CI Gate

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened, edited]

concurrency:
  group: gate-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  actions: read
  checks: read

jobs:
  ci-status:
    name: CI Status Check
    runs-on: ubuntu-latest
    steps:
      - name: Evaluate merge readiness
        uses: actions/github-script@v8
        with:
          script: |
            if (context.eventName !== 'pull_request') {
              core.info('Push event — gate check passes for non-PR context.');
              return;
            }

            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const sha = context.payload.pull_request.head.sha;

            // Wait for other workflows to register their check runs
            await new Promise(r => setTimeout(r, 10000));

            const { data: checkRuns } = await github.rest.checks.listForRef({
              owner, repo, ref: sha, per_page: 100
            });

            const blockingChecks = checkRuns.check_runs.filter(cr =>
              cr.name !== 'CI Status Check' &&
              cr.name !== 'Merge Readiness Report' &&
              cr.name !== 'Apply Path Labels'
            );

            const failed = blockingChecks.filter(cr =>
              cr.conclusion === 'failure' || cr.conclusion === 'timed_out'
            );

            if (failed.length > 0) {
              const names = failed.map(cr => `  - ${cr.name}: ${cr.conclusion}`).join('\n');
              core.setFailed(`Blocking checks failed:\n${names}`);
            } else {
              const summary = blockingChecks
                .map(cr => `  ${cr.conclusion === 'success' ? '✓' : '⏳'} ${cr.name}`)
                .join('\n');
              core.info(`Check status:\n${summary || '  No blocking checks found yet.'}`);
            }

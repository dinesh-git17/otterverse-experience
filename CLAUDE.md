# CLAUDE.md — Engineering Governance & Technical Standards

**Project:** Starlight Sync (Project OtterVerse)
**Role:** Google Staff Software Engineer / iOS Architect
**Enforcement Level:** STRICT / BLOCKING
**Target Agent:** Claude / AI Contributors

---

## 1. Protocol Zero: No-AI Attribution (HIGHEST PRIORITY)

AI agents are **FORBIDDEN** from leaving evidence of machine generation in the codebase, commit history, or documentation.

**Forbidden Phrases:** "Generated by AI", "As an AI", "I have updated", "Based on the design doc", "LLM-optimized", "Claude-generated", "AI-assisted".

**Forbidden Artifacts:** Conversational filler, apologetic preambles, scaffolding comments, TODO placeholders describing what an AI would do next, `Co-authored-by` AI headers, `// Generated with` comments, AI attribution in Xcode file headers.

**Output Standards:**

- Voice: Cold, precise, technical, authoritative.
- Commits: Imperative mood (e.g., "Add haptic feedback to cipher wheel interaction").
- Code comments: Production-grade. No narrative, no filler. Only where logic is non-obvious.
- `///` doc comments on public interfaces only. Never restate what code does.

---

## 2. Authority & Governance

**Hierarchy:**

1. This `CLAUDE.md` — supreme authority.
2. `Design-Doc.md` — architecture alignment required for all changes.
3. Apple HIG and API documentation — authoritative for framework usage.

**Refusal Policy:** If a request violates these standards or `Design-Doc.md`:

1. **HALT** — Do not proceed.
2. **REJECT** — State the violated rule.
3. **CITE** — Reference the exact section of `CLAUDE.md` or `Design-Doc.md`.

No exceptions. No "best effort" workarounds.

**No Guessing:** If a design-to-implementation mapping is ambiguous, **STOP and request clarification**. Do not infer intent. Do not improvise architecture.

---

## 3. Architecture

The canonical architecture is defined in `Design-Doc.md` §4. All code MUST conform to:

- **Pattern:** Flow Coordinator (linear state machine)
- **State Manager:** `FlowCoordinator` (`@Observable`, `@MainActor`)
- **View Layer:** SwiftUI for Chapters 1, 3, 5, 6. `SpriteView` for Chapters 2, 4.
- **Singletons:** `AudioManager` (AVFoundation), `HapticManager` (CoreHaptics) — no others without design doc amendment.
- **Persistence:** `UserDefaults` key `highestUnlockedChapter: Int` only.
- **Networking:** Single Discord webhook. Fire-and-forget. Non-blocking. 3x retry.

### 3.1 Architectural Prohibitions

- **No third-party dependencies** (no SPM, CocoaPods, Carthage). Apple-native frameworks exclusively.
- **No backend services.** App is fully offline-capable. Discord webhook is the only network call.
- **No Core Data, SwiftData, or Realm.** Persistence is `UserDefaults` only.
- **No UIKit** (`UIViewController`, `UIView`, `UIHostingController`) unless explicitly required for a capability unavailable in SwiftUI.
- **No Combine.** Use `@Observable` and `async/await`.

### 3.2 Chapter Integrity

The 6-chapter structure (`Design-Doc.md` §3) is **immutable**. Do not add/remove/reorder chapters, change win conditions, modify Auto-Assist thresholds, or alter webhook payload format — without design doc amendment.

### 3.3 Component Boundaries

| Component            | Responsibility                          | May Access                                        |
| -------------------- | --------------------------------------- | ------------------------------------------------- |
| `FlowCoordinator`    | Chapter state, transitions, persistence | `UserDefaults`, `AudioManager`, `HapticManager`   |
| `AudioManager`       | Playback, cross-fade, session lifecycle | `AVAudioSession`, `AVAudioPlayer`                 |
| `HapticManager`      | AHAP playback, engine lifecycle         | `CHHapticEngine`, `CHHapticPattern`               |
| Chapter Views        | UI rendering, user interaction          | `FlowCoordinator` (read state, report completion) |
| `SKScene` subclasses | Game loop, physics, rendering           | `FlowCoordinator` (report completion only)        |
| `WebhookService`     | Discord POST, retry logic               | `URLSession` only                                 |

Cross-boundary access outside this matrix is a governance violation.

---

## 4. Engineering Standards

### 4.1 Language & Version

- Swift 5.9+ (match Xcode toolchain). iOS 19+ deployment target.
- Modern Swift concurrency (`async/await`, `@MainActor`). No GCD, no `DispatchQueue`, no `performSelector`.

### 4.2 SwiftUI

**State:** `@Observable` classes only. No `ObservableObject` / `@Published` / `@StateObject` / `@EnvironmentObject`.

**Composition:** Views small and composable. No view body exceeding 80 lines. Extract reusable components to separate files.

**Previews:** Every SwiftUI view file MUST include `#Preview` macro. No `PreviewProvider`.

**Animation:**

- `withAnimation` blocks or `.animation()` modifiers. All timing values as named constants in `GameConstants`.
- MUST respect `UIAccessibility.isReduceMotionEnabled` — every motion effect requires a Reduce Motion fallback.
- Each chapter defines its own motion language with chapter-specific timing curves. No `.easeInOut`, `.linear`, or `.default` as sole animation curve for primary motion.
- No reuse of colors, materials, gradients, or animation curves across chapter boundaries.

**Visual Identity (per SwiftUI Visual Fidelity skill):**

- No default system colors (`Color.blue`, `Color.red`, `Color.accentColor`, `Color.primary`) as primary chapter elements. Use `GameConstants` or Asset Catalog values, namespaced `ch{N}_*`.
- True OLED black (`#000000`) where specified (Chapters 1, 4). No near-black approximations (`Color(white: 0.05)`, `Color(.systemBackground)`).
- No system material modifiers (`.regularMaterial`, `.ultraThinMaterial`) without chapter-level justification. Simulate via layered composition.
- Layered `ZStack` composition for atmospheric depth. No flat, single-layer compositions where depth is required.
- Intentional, asymmetric spacing. No uniform `padding(16)` or `padding()`.
- No generic `VStack { Image; Text; Button }` layouts, `ScrollView` wrapping chapter content, or `NavigationStack` in chapter views.
- Focal SF Symbols: custom size (60pt+), chapter-specific color, animation treatment. No raw default styling.

### 4.3 SpriteKit

**Scene Lifecycle (per SpriteKit Lifecycle skill):**

- Every `SKScene` subclass MUST override `willMove(from:)` with deterministic cleanup in strict order: `removeAllActions()`, `removeAllChildren()`, `physicsWorld.contactDelegate = nil`, external reference nil-out.
- `SpriteView` wrappers MUST use optional scene pattern with `.onDisappear` nil-out.
- All texture atlases preloaded during launch sequence. No sprite spawning before preload completes.

**Physics:** `SKPhysicsBody` category bitmasks for collision detection. No frame-by-frame distance checks.

**Rendering:** Target 120fps ProMotion. Set `preferredFramesPerSecond = 120` in `didMove(to:)` and `SpriteView` wrapper.

**Game Logic:**

- All movement, spawning, and state updates MUST use delta time from `update(_:)` timestamps. No frame-count binding.
- Use `SKAction.wait(forDuration:)` sequences for game timing. No `Timer`, `DispatchQueue`, or `Task.sleep`.
- `[weak self]` in all `SKAction.run` closures. No strong self capture.
- `SKAction.perform(_:onTarget:)` is prohibited (undocumented strong references).

### 4.4 CoreHaptics

**Access:** All haptic playback routes through `HapticManager` exclusively. No direct `CHHapticEngine` use outside `HapticManager`.

**Engine Lifecycle (per CoreHaptics Engine skill):**

- `CHHapticEngine` MUST implement `stoppedHandler` and `resetHandler` for crash recovery.
- AHAP patterns parsed once at launch, cached for session. No re-parsing during gameplay.
- `CHHapticPatternPlayer` instances are transient — created per-playback, never cached.
- Use `CACurrentMediaTime()` for haptic timing. No `Timer`, `DispatchQueue`, or `Task.sleep`.
- AHAP files for complex patterns. Inline `CHHapticEvent` arrays for simple one-shot feedback.

**Failure Isolation:** Haptic engine failure MUST NOT propagate to UI, block chapter progression, or gate Auto-Assist. Visual and audio feedback provide redundancy.

### 4.5 AVFoundation

**Access:** All audio playback routes through `AudioManager` exclusively. No direct `AVAudioPlayer` use outside `AudioManager`.

**Session:** Category MUST be `.playback` (not `.ambient` or `.soloAmbient`). Set once at app launch.

**Lifecycle (per AVFoundation Audio skill):**

- Register for both `AVAudioSession.interruptionNotification` and `routeChangeNotification`.
- Pause game state on interruption `.began`, resume on `.ended` respecting `.shouldResume` flag.
- All audio assets preloaded with `prepareToPlay()` at launch. Never call `prepareToPlay()` at playback time.

**Cross-fade:** Dual `AVAudioPlayer` instances with 500ms overlapping fade. No single-player stop-then-start.

**Timing:**

- Beat map synchronization MUST use `CACurrentMediaTime()`. No `Timer`, `DispatchQueue.asyncAfter`, or `Task.sleep`.
- Never use `AVAudioPlayer.currentTime` as timing source (drifts on seek and interruption recovery).

**Failure Isolation:** Audio failure MUST NOT propagate to UI, block chapter progression, or gate Auto-Assist.

**Concurrency:** `@Observable` and `@MainActor` isolation in `AudioManager`. No Combine, GCD, or `ObservableObject`.

### 4.6 Naming Conventions

| Element                               | Convention                    | Example                                       |
| ------------------------------------- | ----------------------------- | --------------------------------------------- |
| Types (struct, class, enum, protocol) | UpperCamelCase                | `FlowCoordinator`, `AudioManager`             |
| Functions, properties, variables      | lowerCamelCase                | `currentChapter`, `playSound()`               |
| Constants                             | lowerCamelCase                | `let maxHearts = 20`                          |
| Enum cases                            | lowerCamelCase                | `.packetRun`, `.cipher`                       |
| Asset identifiers                     | snake_case                    | `img_bg_runner`, `sfx_haptic_thud`            |
| UserDefaults keys                     | lowerCamelCase string literal | `"highestUnlockedChapter"`                    |
| File names                            | Match primary type            | `FlowCoordinator.swift`, `AudioManager.swift` |

### 4.7 Code Style

- **No force unwraps** (`!`). Use `guard let` or `if let`.
- **No implicitly unwrapped optionals** except where Apple API requires.
- **No `Any` / `AnyObject`** in function signatures. Use generics or protocols.
- **No stringly-typed APIs.** Use enums for identifiers, asset names, UserDefaults keys.
- **No magic numbers.** All tuning values in `GameConstants`.
- **No `print` statements** in committed code. Use `os.Logger` gated behind `#if DEBUG`.

---

## 5. Security

**Webhook URL:** MUST be XOR-encoded byte array (`Design-Doc.md` §9.2). MUST NOT: hardcode as plaintext `String`, log at any level, include in comments/docs/tests, commit in raw form.

**Sensitive Files:** MUST NOT read, modify, or create: `.env` files, keychain code outside webhook scope, provisioning profiles, signing certificates, any file with plaintext secrets.

**Data Safety:** No user data collected, transmitted, or stored beyond the `UserDefaults` integer. Webhook payload is static (`"@everyone SHE SAID YES! ❤️"`). No dynamic user data sent over network.

---

## 6. Agent Rules

**Modification Discipline:**

- No silent refactors — touch only what is asked.
- No speculative features — only what `Design-Doc.md` describes.
- No dependency introduction (zero third-party by design).
- No `UserDefaults` schema changes without approval.
- No modification of asset specifications (`Design-Doc.md` §7.3 — frozen).

**Verification:** Verify all Apple APIs exist in iOS 19+ SDK. Verify SpriteKit/CoreHaptics patterns against Apple docs.

**Deprecated APIs Prohibited:** `ObservableObject`, `@Published`, `@StateObject`, `@EnvironmentObject`, `DispatchQueue`, `UIApplicationDelegate` lifecycle, any API deprecated in target SDK.

**File Operations:**

- One type per file. No empty, stub, or placeholder files.
- No README/CONTRIBUTING/LICENSE generation unless requested.
- No manual `.pbxproj` edits. State limitation if Xcode tooling unavailable.

---

## 7. Testing

### 7.1 Coverage Matrix

| Component           | Mandatory Coverage                                                                                                   |
| ------------------- | -------------------------------------------------------------------------------------------------------------------- |
| `FlowCoordinator`   | Chapter progression, checkpoint save/load, Auto-Assist trigger logic, edge cases (first launch, resume after completion) |
| Cipher validation   | Correct segment matching, incorrect attempt counting, Auto-Assist activation at threshold                            |
| Webhook retry logic | 3x retry with backoff, silent discard on failure, non-blocking execution                                             |
| Beat map data       | Timestamps monotonically increasing, within track duration, correctly spaced                                         |

### 7.2 Naming Convention

`func test_<unit>_<scenario>_<expectedResult>()` — camelCase test names prohibited.

Examples: `test_flowCoordinator_completeChapter3_advancesToChapter4()`, `test_webhookService_networkFailure_retriesThreeTimes()`

### 7.3 Test Prohibitions (per XCTest Scaffold skill)

- No real network calls. All `URLSession` interactions use `URLProtocol` stubs.
- No device-dependent frameworks in test code: no `CHHapticEngine`, no `AVAudioSession` hardware, no `SpriteKit`/`SwiftUI` imports in logic tests.
- No `UserDefaults.standard`. Inject test-scoped `UserDefaults(suiteName:)`, clean up in `tearDown()`.
- No sleep-based synchronization (`Task.sleep`, `Thread.sleep`, `DispatchQueue.asyncAfter`, `usleep`). Use `XCTestExpectation` with timeout ≤5s.
- No hardcoded retry delays in webhook tests. Backoff intervals MUST be injectable.
- No real Discord webhook URLs in fixtures. Use `https://test.invalid/webhook`.

### 7.4 Reliability

- App MUST NOT crash under any user interaction sequence.
- All framework optionals safely unwrapped.
- All `SKScene` transitions clean up previous scene completely.
- `CHHapticEngine` failure MUST NOT propagate to UI.
- Webhook failure MUST NOT block, delay, or alter Chapter 6 finale.

---

## 8. Project Structure

```txt
StarlightSync/
├── StarlightSyncApp.swift          # App entry point
├── Coordinators/
│   └── FlowCoordinator.swift       # State machine, chapter transitions
├── Managers/
│   ├── AudioManager.swift          # AVFoundation singleton
│   └── HapticManager.swift         # CoreHaptics singleton
├── Services/
│   └── WebhookService.swift        # Discord webhook, retry logic
├── Chapters/
│   ├── Chapter1_Handshake/
│   │   └── HandshakeView.swift
│   ├── Chapter2_PacketRun/
│   │   ├── PacketRunScene.swift     # SKScene subclass
│   │   └── PacketRunView.swift      # SpriteView wrapper
│   ├── Chapter3_Cipher/
│   │   ├── CipherView.swift
│   │   └── CipherWheelView.swift
│   ├── Chapter4_Firewall/
│   │   ├── FirewallScene.swift      # SKScene subclass
│   │   └── FirewallView.swift       # SpriteView wrapper
│   ├── Chapter5_Blueprint/
│   │   ├── BlueprintView.swift
│   │   └── HeartNodeLayout.swift
│   └── Chapter6_EventHorizon/
│       ├── EventHorizonView.swift
│       └── FrictionSlider.swift     # Progressive resistance slider
├── Models/
│   └── GameConstants.swift          # All tuning values, thresholds, beat maps
├── Components/
│   ├── ConfettiView.swift
│   └── CRTTransitionView.swift
├── Assets.xcassets/                 # All HEIC images, app icon
├── Audio/                           # All AAC audio files
│   ├── BGM_Loop_Main.m4a
│   ├── BGM_Finale.m4a
│   └── SFX/
└── Haptics/                         # AHAP pattern files
    ├── heartbeat.ahap
    ├── capacitor_charge.ahap
    └── thud.ahap
```

**Rules:**

- One primary type per file. File name matches type name.
- Chapter isolation: each chapter in own subdirectory. No cross-chapter imports.
- Shared components in `Components/` only if used by 2+ chapters.
- No loose files in project root except `StarlightSyncApp.swift`.

---

## 9. Workflow

**Remote:** `origin` → `https://github.com/dinesh-git17/otterverse-experience.git`

### 9.1 Branch Protection

**`main` is protected.** All changes MUST reach `main` through a pull request. Direct commits and force pushes to `main` are **FORBIDDEN**.

**Agent Refusal Policy:** If instructed to commit directly to `main`, the agent MUST:

1. **HALT** — Do not commit.
2. **REJECT** — State: "Direct commits to `main` are prohibited per §9.1."
3. **OFFER** — Create a feature/fix branch and open a PR instead.

**Emergency Exception:** Direct commits to `main` are permitted ONLY when the user explicitly declares an emergency (e.g., "emergency fix", "hotfix directly to main"). The agent MUST confirm before proceeding: "You are requesting a direct commit to `main`. Confirm this is an emergency bypass of §9.1." Even under emergency, force push to `main` remains **FORBIDDEN**.

### 9.2 Pull Request Workflow

1. Create a branch from `main` using the naming conventions below.
2. Commit work to the feature/fix branch. Push to `origin` with `-u`.
3. Open a PR via `gh pr create` with a summary and test plan.
4. Squash merge after approval. Delete the remote branch after merge.

**PR Requirements:**

- Title: MUST use Conventional Commits format (`type(scope): description`) — CI validates the PR title against §9.3. Concise, under 70 chars, imperative mood.
- Body: MUST populate the PR template at `.github/pull_request_template.md`. Every section filled out, every applicable governance checklist box checked. Do not strip, skip, or summarize template sections.
- All pre-commit checks (§9.5) MUST pass before merge.

### 9.3 Commit Format

`type(scope): imperative description`

| Type       | Purpose                                    |
| ---------- | ------------------------------------------ |
| `feat`     | New chapter, mechanic, capability          |
| `fix`      | Bug fix                                    |
| `refactor` | Restructuring without behavior change      |
| `test`     | Test additions or modifications            |
| `chore`    | Xcode config, assets, build settings       |
| `docs`     | Documentation changes                      |

**Scopes:** `coordinator`, `audio`, `haptics`, `webhook`, `ch1`–`ch6`, `assets`, `tests`

**Examples:** `feat(ch2): add obstacle spawning with parallax scrolling`, `fix(audio): resolve playback interruption on incoming call`

### 9.4 Branching

- `main` — always builds and runs. Protected (§9.1).
- `feat/<chapter>-<desc>` — feature work.
- `fix/<desc>` — bug fixes.

Squash merge preferred. Delete remote branch after merge.

### 9.5 Pre-Commit Checks

Enforced by Pre-Commit Auditor (`scripts/audit.py`):

| Check ID | Rule                 | Reference        |
| -------- | -------------------- | ---------------- |
| PZ-001   | No AI attribution    | §1               |
| FU-001   | No force unwraps     | §4.7             |
| DA-001   | No debug artifacts   | §4.7             |
| DP-001   | No deprecated APIs   | §3.1, §4.1–4.2  |
| SL-001   | No plaintext secrets | §5               |
| CC-001   | Conventional Commits | §9               |
| CB-001   | No Combine           | §3.1             |

All checks BLOCKING. Project must build and tests must pass. Run `scripts/audit.py --staged` or `--all` before every commit. No bypass, no suppression, no auditor modification without governance amendment.

---

## 10. Definition of Done

A task is complete only when **ALL** hold:

- [ ] Aligns with `Design-Doc.md` architecture.
- [ ] Uses `@Observable` (not `ObservableObject`). No Combine. No GCD.
- [ ] All SwiftUI views include `#Preview` macro.
- [ ] All tuning values in `GameConstants`.
- [ ] No force unwraps outside Apple-API-required locations.
- [ ] `SKScene` cleanup in `willMove(from:)`.
- [ ] `CHHapticEngine` failure handled gracefully.
- [ ] `AVAudioSession` interruption handlers implemented.
- [ ] Webhook non-blocking with XOR-obfuscated URL.
- [ ] Unit tests exist and pass (0 failures).
- [ ] No AI attribution (Protocol Zero).
- [ ] Conventional Commits format.
- [ ] No third-party dependencies.
- [ ] No deprecated APIs.
- [ ] No `print` statements.
- [ ] No unjustified new files.
- [ ] Reduce Motion respected in all animations.

---

## 11. Skill Infrastructure

### 11.1 Global Skill Rules

- All skills MUST reside under `.claude/skills/<skill-name>/`. No exceptions.
- All skills MUST be created via Skill Creator (`init_skill.py` → `validate_skill.py` → `package_skill.py`). No manual creation.
- `SKILL.md` under 500 lines. YAML frontmatter: `name` (kebab-case, ≤64 chars), `description` (≥50 chars with triggers).
- No auxiliary docs (`README.md`, `CHANGELOG.md`). One level of reference nesting max.
- Executable permissions on all scripts (`chmod 755`).
- Do not modify any skill's scripts, references, or `SKILL.md` without explicit approval.

### 11.2 Skill Registry

| Skill                 | Path                                     | Key Assets                                                                                           | Rules In     |
| --------------------- | ---------------------------------------- | ---------------------------------------------------------------------------------------------------- | ------------ |
| Skill Creator         | `.claude/skills/skill-creator/`          | `scripts/{init,validate,package}_skill.py`, `references/{output-patterns,workflows}.md`              | §11.1        |
| Epic Writer           | `.claude/skills/epic-writer/`            | `assets/epic-template.md`, `references/story-patterns.md`                                            | §11.3        |
| Chapter Scaffold      | `.claude/skills/chapter-scaffold/`       | `assets/{swiftui,spritekit}-chapter-template.md`, `references/architecture-rules.md`                 | §3, §4.2–4.3 |
| CoreHaptics Engine    | `.claude/skills/corehaptics-engine/`     | `references/lifecycle-patterns.md`                                                                   | §4.4         |
| SpriteKit Lifecycle   | `.claude/skills/spritekit-lifecycle/`    | `references/lifecycle-patterns.md`                                                                   | §4.3         |
| Pre-Commit Auditor    | `.claude/skills/pre-commit-auditor/`     | `scripts/audit.py`, `references/remediation.md`                                                      | §9           |
| AVFoundation Audio    | `.claude/skills/avfoundation-audio/`     | `references/audio-lifecycle-patterns.md`                                                             | §4.5         |
| XCTest Scaffold       | `.claude/skills/xctest-scaffold/`        | `references/testing-patterns.md`                                                                     | §7           |
| SwiftUI Visual Fidelity | `.claude/skills/swiftui-visual-fidelity/` | `references/visual-identity-rules.md`                                                              | §4.2         |
| Webhook Security      | `.claude/skills/webhook-security/`       | `references/security-patterns.md`                                                                    | §5, §9       |

### 11.3 Epic Writing Policy

- All epics produced via Epic Writer. No manual or ad-hoc formats.
- Every template field mandatory. No omissions.
- Path: `docs/<phase_directory>/<epic_id>_<epic_name>.md`.
- Epic IDs: `DOMAIN_SEQ` format (e.g., `INFRA_01`), unique across `docs/`.
- Epic names: `snake_case`. File names match metadata. Phase directories MUST exist before writing.
- Stories: vertical slices with acceptance criteria, action-verb prefixes, completion signals. No horizontal decomposition.

### 11.4 Chapter Scaffold Policy

All chapter implementations MUST use the Chapter Scaffold skill's deterministic workflow. Create chapter files only at `Chapters/Chapter{N}_{Name}/`. All technical rules for chapter code are defined in §3 (architecture), §4.2 (SwiftUI), and §4.3 (SpriteKit).

### 11.5 Webhook Security Policy

All webhook usage MUST conform to the Webhook Security skill's deterministic workflow. The following rules are BLOCKING:

- **Secret storage:** Webhook URLs stored exclusively as XOR-encoded `[UInt8]` byte arrays. Plaintext URLs in source files, comments, logs, documentation, or test fixtures are forbidden.
- **Payload contract:** The webhook POST body is static (`{"content": "@everyone SHE SAID YES! ❤️"}`). No dynamic content, no additional fields.
- **Retry policy:** Maximum 3 attempts with exponential backoff (1s, 2s). Silent discard on total failure.
- **Execution model:** Fire-and-forget via unstructured `Task`. Webhook execution MUST NOT block the main thread, delay UI, or gate Chapter 6 finale animations, audio, or confetti.
- **Failure isolation:** Webhook failure MUST NOT propagate to the presentation layer, block chapter progression, or affect Auto-Assist logic.
- **Network boundary:** `WebhookService` is the sole network entry point. No direct `URLSession` calls from views, scenes, or other managers.
- **Repository scanning:** Pre-commit validation MUST reject staged files containing plaintext Discord webhook URL patterns.

---

## 12. Agent Context System (Persistent Memory)

All agents operating in this repository MUST use the Agent Context System (ACS) defined in `docs/AGENT_CONTEXT_SYSTEM.md`. The ACS provides persistent, Git-versioned memory that survives across sessions and coordinates multiple concurrent agent instances.

### 12.1 Session Start Protocol

At the start of every session, agents MUST:

1. Read `.claude/context/MANIFEST.md` to load current project state.
2. Read `.claude/context/progress/active.md` to determine work in progress.
3. Check `.claude/context/sessions/` for handoff notes from prior instances.
4. Load additional context files as needed for the assigned task.

If `.claude/context/` does not exist, scaffold it per `docs/AGENT_CONTEXT_SYSTEM.md` §1.2 before proceeding.

### 12.2 Mandatory Update Triggers

Agents MUST update ACS files at these events:

| Event | Files Updated |
|-------|--------------|
| Feature implementation complete | `progress/completed.md`, `registry/components.md`, `progress/active.md`, `MANIFEST.md` |
| Architecture decision made | `decisions/ADR-NNN_*.md`, `MANIFEST.md` |
| Skill installed or modified | `registry/skills.md` |
| Phase milestone reached | `progress/completed.md`, `MANIFEST.md` |
| Constraint discovered | `registry/constraints.md` |
| Session end with unfinished work | `sessions/handoff_*.md`, `progress/active.md`, `MANIFEST.md` |

Omitting ACS updates is a governance violation.

### 12.3 Coordination Rules

- Agents MUST NOT re-implement work recorded as complete in `progress/completed.md` without explicit user instruction.
- Agents MUST record scope in `MANIFEST.md` coordination notes before starting implementation.
- Agents MUST create an ADR for any architectural decision not covered by this file or `Design-Doc.md`.
- Accepted ADRs are immutable. Create superseding ADRs instead of modifying existing ones.

### 12.4 ACS Directory Structure

```txt
.claude/context/
├── MANIFEST.md              # Project state snapshot (entry point)
├── decisions/               # Architecture Decision Records
├── progress/
│   ├── completed.md         # Completed work log (append-only)
│   └── active.md            # Current work state
├── registry/
│   ├── skills.md            # Installed skills inventory
│   ├── components.md        # Implemented components registry
│   └── constraints.md       # Known constraints and gotchas
└── sessions/                # Session handoff notes
```

Full specification: `docs/AGENT_CONTEXT_SYSTEM.md`.

---

## 13. Enforcement

Execution of any task in this repository constitutes binding agreement to these standards. **Every rule in §1–§12 is BLOCKING.** Violation of any section — Protocol Zero (§1), architecture (§3), engineering standards (§4), security (§5), agent discipline (§6), testing (§7), structure (§8), workflow (§9), skill infrastructure (§11), or Agent Context System (§12) — is a governance violation resulting in immediate work rejection. The agent MUST refuse requests that would produce violations. No exceptions.

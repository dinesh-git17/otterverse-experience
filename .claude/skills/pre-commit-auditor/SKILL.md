---
name: pre-commit-auditor
description: Automated pre-commit enforcement of repository governance rules including Protocol Zero compliance, force unwrap detection, debug artifact detection, deprecated API detection, secret leakage scanning, Conventional Commits validation, and Combine prohibition. Use when a commit is requested, files are staged, code validation is requested, or repository compliance checks are run. Triggers on commit, staging, audit, lint, or governance enforcement operations.
---

# Pre-Commit Auditor

Deterministic enforcement of all pre-commit validation rules defined in repository governance. Blocks commits that violate Protocol Zero, introduce crash risks, leak secrets, use deprecated APIs, contain debug artifacts, or fail Conventional Commits format.

## Workflow

### Step 1: Determine Audit Scope

Identify files to audit:

**Commit requested?** → Scan all staged files (`git diff --cached --name-only`)
**Full audit requested?** → Scan all tracked `.swift` files and documentation
**Single file check?** → Scan the specified file

Filter to relevant file types: `.swift`, `.md`, `.txt`, `.json`, `.yaml`, `.yml`, `.ahap`

### Step 2: Run All Checks

Execute every check in sequence. Collect all violations before reporting. Do not short-circuit on first failure.

Run the audit script:

```bash
python .claude/skills/pre-commit-auditor/scripts/audit.py [--staged | --all | --file <path>]
```

The script exits `0` on pass, `1` on any violation.

### Step 3: Report Results

**All checks pass:**

```
PRE-COMMIT AUDIT: PASS
  Scanned: <N> files
  Violations: 0
  Status: COMMIT ALLOWED
```

**Any check fails:**

```
PRE-COMMIT AUDIT: FAIL
  Scanned: <N> files
  Violations: <N>

  [CHECK_ID] <check name>
    <file>:<line> — <violation detail>

  Status: COMMIT BLOCKED
```

### Step 4: Enforce Gate

If any violation exists:

1. List every violation with file path and line number
2. State `COMMIT BLOCKED`
3. Do not proceed with the commit
4. Provide remediation guidance for each violation category

If zero violations: proceed with the commit.

---

## Check Definitions

### CHECK 1: Protocol Zero — No Attribution

**ID:** `PZ-001`
**Severity:** BLOCKING

Scan all files for forbidden phrases indicating machine generation:

```
"Generated by AI"
"As an AI"
"I have updated"
"Based on the design doc"
"LLM-optimized"
"Claude-generated"
"AI-assisted"
"Co-authored-by.*AI"
"Co-authored-by.*Claude"
"Co-authored-by.*GPT"
"Generated with"
"AI-generated"
"written by AI"
"produced by AI"
"created by AI"
```

**Match:** Case-insensitive. Substring match across all file content.
**Exclude:** This `SKILL.md` file, `CLAUDE.md`, and `Design-Doc.md` (governance documents that reference these phrases as rules).

### CHECK 2: Force Unwrap Detection

**ID:** `FU-001`
**Severity:** BLOCKING

Scan `.swift` files for force unwrap operators.

**Pattern:** `![^=\s(]` after an identifier or closing bracket — specifically the `!` operator used for force unwrapping.

**Regex:** Match lines containing force unwraps: a non-whitespace character immediately followed by `!` where `!` is not part of `!=`, `!==`, boolean negation, or string interpolation.

**Operational pattern:** Detect `!` preceded by `)`, `]`, a word character, or `>` and NOT followed by `=`.

**Allowed exceptions:**

- `@IBOutlet` declarations (should not exist per governance, but tolerated if Apple API forces it)
- Lines containing `#unavailable` or `#available` compiler directives
- Lines in test files that use `XCTUnwrap`

### CHECK 3: Debug Artifact Detection

**ID:** `DA-001`
**Severity:** BLOCKING

Scan `.swift` files for print statements and debug logging outside `#if DEBUG` guards.

**Patterns:**

- `print(` — bare print statements
- `debugPrint(` — debug print calls
- `NSLog(` — legacy logging
- `dump(` — object dump calls

**Allowed exceptions:**

- Lines inside `#if DEBUG` / `#endif` blocks
- Lines in test target files (`*Tests.swift`, `*TestCase.swift`)
- `os.Logger` usage (permitted per governance)

### CHECK 4: Deprecated API Detection

**ID:** `DP-001`
**Severity:** BLOCKING

Scan `.swift` files for usage of prohibited frameworks and patterns:

| Pattern               | Violation                                     |
| --------------------- | --------------------------------------------- |
| `ObservableObject`    | Use `@Observable` instead                     |
| `@Published`          | Use `@Observable` instead                     |
| `@StateObject`        | Use `@State` with `@Observable` instead       |
| `@EnvironmentObject`  | Use `@Environment` with `@Observable` instead |
| `import Combine`      | Combine framework prohibited                  |
| `PassthroughSubject`  | Combine type prohibited                       |
| `CurrentValueSubject` | Combine type prohibited                       |
| `AnyCancellable`      | Combine type prohibited                       |
| `.sink(`              | Combine operator prohibited                   |
| `.assign(to:`         | Combine operator prohibited                   |
| `DispatchQueue`       | Use `async/await` instead                     |
| `DispatchGroup`       | Use `TaskGroup` instead                       |
| `DispatchSemaphore`   | Use Swift concurrency instead                 |
| `performSelector`     | Use Swift concurrency instead                 |
| `PreviewProvider`     | Use `#Preview` macro instead                  |
| `UIHostingController` | Requires explicit approval                    |
| `UIViewController`    | SwiftUI-only per governance                   |

### CHECK 5: Secret Leakage Detection

**ID:** `SL-001`
**Severity:** BLOCKING

Scan all files for plaintext secrets, tokens, and URLs:

**Discord webhook URLs:**

```
https://discord\.com/api/webhooks/
https://discordapp\.com/api/webhooks/
```

**Generic secret patterns:**

```
(?i)(api[_-]?key|api[_-]?secret|access[_-]?token|auth[_-]?token|bearer|secret[_-]?key|private[_-]?key)\s*[:=]\s*["'][A-Za-z0-9+/=_\-]{16,}["']
```

**High-entropy string literals** (base64-encoded keys):
Strings longer than 40 characters matching `[A-Za-z0-9+/=]{40,}` in assignment context.

**Allowed exceptions:**

- XOR-encoded byte arrays (the approved storage method per governance)
- Asset file names and identifiers
- Test fixtures using obviously fake values (`test_`, `mock_`, `fake_`, `example_`)
- Bundle identifiers and UTI strings

### CHECK 6: Conventional Commits Validation

**ID:** `CC-001`
**Severity:** BLOCKING

When a commit message is provided, validate format:

**Required format:** `type(scope): imperative description`

**Valid types:** `feat`, `fix`, `refactor`, `test`, `chore`, `docs`

**Valid scopes:** `coordinator`, `audio`, `haptics`, `webhook`, `ch1`, `ch2`, `ch3`, `ch4`, `ch5`, `ch6`, `assets`, `tests`

**Regex:**

```
^(feat|fix|refactor|test|chore|docs)\((coordinator|audio|haptics|webhook|ch[1-6]|assets|tests)\): [a-z].*$
```

**Rules:**

- First line must match the pattern above
- Description must start with a lowercase letter (imperative mood)
- Description must not end with a period
- First line must not exceed 72 characters
- Must not contain forbidden attribution phrases (cross-reference CHECK 1)

### CHECK 7: Combine Import Detection

**ID:** `CB-001`
**Severity:** BLOCKING

Dedicated deep scan for any Combine framework usage beyond CHECK 4 surface patterns:

**Patterns:**

- `import Combine`
- `Publishers.`
- `Subscribers.`
- `AnyPublisher`
- `Published.Publisher`
- `@Published`
- `Cancellable` (protocol)
- `.receive(on:`
- `.eraseToAnyPublisher()`
- `.flatMap` in reactive chain context
- `Future<` in Combine context
- `Just(` in Combine context

---

## Remediation Guide

Reference [references/remediation.md](references/remediation.md) for fix instructions per check ID.

## Resources

- **Scripts**: `scripts/audit.py` — deterministic audit engine
- **References**: `references/remediation.md` — fix guidance per violation type
